// ğŸ“ tts/textPreprocess.js â€“ ×—×™×“×•×“ ×˜×§×¡×˜×™× ×œÖ¾TTS OpenAI

const ttsNikudMap = [
  { from: /FIFO/gi, to: '×¤Ö´Ö¼×™×¤×•Ö¹' },
  { from: /×’×™×™××¨×™×/gi, to: '×’Öµ×™Ö°×Öµ×¨Ö´×™×' },
  { from: /×’×™×™××¨/gi, to: '×’Öµ×™Ö°×Öµ×¨' },
  { from: /××—×™/gi, to: '×Ö·×—Ö´×™' },
  { from: /×•×•××œ×”/gi, to: '×•Ö·××œÖ¸Ö¼×”' },
  { from: /××©×›×¨×”/gi, to: '×Ö·×©Ö°××›Ö¸Ö¼×¨Ö¸×”' },
  { from: /××™×§×¨×•×¤×•×Ÿ/gi, to: '×Ö´×™×§Ö°×¨×•Ö¹×¤×•Ö¹×Ÿ' },
  { from: /×§×œ×™××¨×•/gi, to: '×§Ö¸×œÖ´×™×Öµ×¨×•Ö¹' },
  { from: /×¨×•×¢×™/gi, to: '×¨×•Ö¹×¢Ö´×™' },
  { from: /×™×•×’×™/gi, to: '×™×•Ö¹×’Ö´×™' },
  { from: /××ª×Ÿ/gi, to: '×Ö¸×ªÖ¸×Ÿ' },
  { from: /×¢××¨×™/gi, to: '×¢Ö¸×Ö°×¨Ö´×™' },
  { from: /×’×œ×¢×“/gi, to: '×’Ö´Ö¼×œÖ°×¢Ö¸×“' },
  { from: /××‘×™×—×™/gi, to: '×Ö²×‘Ö´×™×—Ö·×™' },
  // ×”×•×¡×£ ×¢×•×“ ××™×œ×™× ×§×©×•×ª/×¡×œ× ×’ ××©×œ×š!
];

// ×”×•×¡×¤×ª × ×™×§×•×“ (×•×ª×™×§×•×Ÿ ××™×œ×™× ×‘×¢×™×™×ª×™×•×ª)
function autoNikud(text) {
  let res = text;
  ttsNikudMap.forEach(({from, to}) => {
    res = res.replace(from, to);
  });
  return res;
}

// ×”×•×¡×¤×ª ×¤×™×¡×•×§ ×•×¢×¦×™×¨×•×ª ×—×›××•×ª
function smartPunctuation(text) {
  let res = text.trim();

  // ×¤×¡×™×§×™× ××—×¨×™ ×›×œ ××™×œ×” ×‘×¢×‘×¨×™×ª ×‘××•×¨×š 5+ (×œ×”××˜)
  res = res.replace(/([×-×ª]{5,})/g, '$1,');

  // × ×§×•×“×” ×›×œ 2â€“3 ××©×¤×˜×™×
  res = res.replace(/([.?!])([^ ])/g, '$1 $2');
  res = res.replace(/([.?!])$/g, '$1 ');

  // ×œ× ×œ××¤×©×¨ ×¦×‘×™×¨×ª ×¤×¡×™×§×™×
  res = res.replace(/,+/g, ',');

  // ×œ×”×¤×•×š ×¨×¦×£ ×©×œ ×©×œ×•×© ××™×œ×™× â€“ ×œ××¢×™×Ÿ "×¢×™×•×•×ª"
  res = res.replace(/([×-×ª]{3,}) ([×-×ª]{3,}) ([×-×ª]{3,})/g, '$1, $2, $3');

  // ×¢×¦×™×¨×” ×“×¨××˜×™×ª ××—×¨×™ ×¡×™××Ÿ ×§×¨×™××”
  res = res.replace(/!/g, '! ...');

  return res;
}

// ××¤×©×¨ ×œ×”×•×¡×™×£ ×›××Ÿ ×¢×™×•×•×ª×™× ××™×•×—×“×™× (××•×ª×™×•×ª ××•×¤×¨×“×•×ª)
function dramatizeHebrew(text) {
  return text.replace(/(\b[×-×ª]{5,}\b)/g, (m) =>
    m.split('').join('-')
  );
}

// ×”××¨×” ×¡×•×¤×™×ª
function preprocessTTS(text) {
  let out = text;
  out = autoNikud(out);        // ×©×œ×‘ 1 â€“ × ×™×§×•×“ ×•×¢×™×•×•×ª×™×
  out = smartPunctuation(out); // ×©×œ×‘ 2 â€“ ×¤×™×¡×•×§ ×—×›×
  // ××¤×©×¨ ×œ×”×¤×¢×™×œ dramatizeHebrew(out) ×× ×¨×•×¦×™× ×œ×”×“×’×™×© ×©××•×ª/××™×œ×™× (×œ×”×©×ª××© ×‘×–×”×™×¨×•×ª)
  return out;
}

module.exports = {
  preprocessTTS
};
