const openai = require("openai"); // ×•×“× ×©×§×•× ×¤×™×’×•×¨×¦×™×” ×§×™×™××ª

const PEOPLE = [
  {
    name: "×§×œ×™××¨×•",
    aliases: ["×§××œ×™", "×§×œ×™", "×§×œ×™××¨×•", "×¢××™×ª", "××¤×œ×œ×•", "×¢×¤×œ×œ×•", "×¢×¤×•×œ×”", "×‘×™×¦×”"],
    user: null,
    left: true,
    traits: [
      "×¢×–×‘ ××ª ×”×§×‘×•×¦×” ×‘×œ×™ ×œ×”×¡×‘×™×¨",
      "× ×¢×œ×‘ ××›×œ ×“×‘×¨",
      "×›×•×¡×™×ª",
      "×¨×’×™×© ××“×™",
      "×”×“×•×“×” ×©×œ×• ×©×•×œ×˜×ª ×¢×œ×™×•",
      "× ××¡ ×××™× ×—××™×",
      "×‘×™×¦×” ×©×‘×•×¨×”",
      "×—×•×‘×‘ ×“×¨××•×ª"
    ]
  },
  {
    name: "×˜×œ ×¢×™×™×©",
    aliases: ["×˜×œ", "×¢×™×™×©", "× ×•×›×œ ×”×˜×™× ×“×¨", "×¢×‘×¨×™×™×Ÿ", "×¦××¨×ª", "×¢×•×§×¥", "×“×•×’××Ÿ", "××¤×ª×—", "×”×™×™×˜×§×™×¡×˜"],
    user: null,
    left: true,
    traits: [
      "×“×•×’××Ÿ ×›×•×©×œ",
      "×¢×•×§×¥ × ×©×™×",
      "×—×™ ×‘×¡×¨×˜",
      "××™×© ×”×™×™×˜×§ ×¢× ×¢×‘×¨ ×¤×œ×™×œ×™",
      "×”×™×” ×‘×¦××¨×ª ×•× ×¤×œ",
      "× ×•×›×œ ×”×˜×™× ×“×¨ ×©×œ ××©×§×œ×•×Ÿ"
    ]
  },
  {
    name: "×¢×•××¨×™ ×¢××¨",
    aliases: ["×¢××¨", "×¢×•××¨×™", "×¨××© ×‘×™×¦×”", "×§×¨×—×ª"],
    user: "@Tokyo1987",
    left: false,
    traits: [
      "×’×¨ ×‘×–×›×¨×•×Ÿ ×™×¢×§×‘",
      "×”×§×¨×—×ª ×”×›×™ ××‘×¨×™×§×” ×‘×™×©×¨××œ",
      "×•×•×¨×“ ×©×•×œ×˜×ª ×‘×‘×™×ª",
      "××’×¨×‘×¥ ×¨×•×‘ ×”×™×•×",
      "××¢×©×Ÿ ×™×¨×•×§ ×‘×—× ×•×ª ××œ×§×˜×¨×•× ×™×§×”"
    ]
  },
  {
    name: "×©×¨×•×Ÿ",
    aliases: ["×©×¨×•×Ÿ", "×©×¨×•× ×”", "×‘×ª ×™×", "×¤×•×ª×— ×§×•×¤×¡××•×ª"],
    user: "@SHARON26TAL",
    left: false,
    traits: [
      "××•×”×‘ ×œ×¤×ª×•×— ×§×•×¤×¡××•×ª",
      "××’×™×‘ ×œ×›×œ ×“×‘×¨",
      "×—×™ ×‘×‘×ª ×™×",
      "××‘×™×Ÿ ×‘××‘×¦×¢×™× ×©×œ ×¡×•×¤×¨×¤××¨×"
    ]
  },
  {
    name: "××ª×Ÿ ×›×œ×£",
    aliases: ["××ª×Ÿ", "×¤×•×¨×™×", "××ª× ×•×¡", "×›×œ×¤×•×Ÿ", "×—×œ×¤×•×Ÿ", "×§××œ×™×¤×”", "×›×œ×™×¤×”", "××ª× ×”"],
    user: "@Matan_CH",
    left: false,
    traits: [
      "×—×™ ×‘×ª×—×¤×•×©×ª ×ª××™×“×™×ª",
      "×©×•×‘×¨ ××ª ×”×¨×©×ª ×‘×¤×•×¨×™×",
      "××—×¤×© ××™×©×•×¨ ××›×œ ×”×¡×•×‘×‘×™×",
      "×›×œ×£ ×¢× × ×¡×™×•×Ÿ"
    ]
  },
  {
    name: "×’×œ×¢×“ ×”×’×œ×¢×“×™",
    aliases: ["×’×œ×¢×“"],
    phone: "+972545834665",
    user: null,
    left: false,
    traits: [
      "×ª×œ ××‘×™×‘×™ ×œ×©×¢×‘×¨, ×’×¨ ×‘×¨×—×•×‘×•×ª",
      "×©×•× × ××ª ×‘×™×‘×™",
      "×©×××œ× ×™ ×§×¤×œ× ×™×¡×˜×™",
      "××¨×›×™×‘ ××©×§×¤×™×™×",
      "××•×”×‘ ×¢×œ ×”××©",
      "×—×•×œ× ×¢×œ ×¤×©×¨×”"
    ]
  },
  {
    name: "××©×” ×‘×™×˜×•×Ÿ (×“×•×“×•)",
    aliases: ["××©×”", "×‘×™×˜×•×Ÿ", "×“×•×“×• ××©×”", "×“×•×“×•"],
    user: "@Deadzik32",
    left: false,
    traits: [
      "×¢×•×‘×“ ×‘××œ×ª×",
      "××ª×—×ª×Ÿ ×‘Ö¾14.9.25",
      "×¢×•×‘×“ ×¢× ××‘× ×©×œ×• ×‘××™× ×¡×˜×œ×¦×™×”",
      "×™×©×Ÿ ×¨×•×‘ ×”×–××Ÿ",
      "×¦×™× ×™ ×‘×œ×‘"
    ]
  },
  {
    name: "×× ×©",
    aliases: ["×× ×©", "×× ×©×”"],
    phone: "+972506867097",
    user: null,
    left: false,
    traits: [
      "××™×œ×•××™×× ×™×§ ×××™×ª×™",
      "×ª×•×¨× ×œ××“×™× ×” ×‘×©×§×˜",
      "×œ× ××—×•×‘×¨ ×œ×˜×œ×’×¨×",
      "××™×© ×©×œ ××¢×©×™×"
    ]
  },
  {
    name: "×¨×•×¡×œ×Ÿ (×¨×•×¢×™)",
    aliases: ["×¨×•×¡×œ×Ÿ", "×¨×•×¡×œ× ×”", "×¨×•×¢×™"],
    phone: "+972506885455",
    user: null,
    left: false,
    traits: [
      "×¨×•×¡×™ ×¡×•×‘×™×™×˜×™ ×¢× × ×©××”",
      "××•×”×‘ ×œ×”×ª×××Ÿ",
      "×¨×•×•×§",
      "×©×•××¨ ×¢×œ ×”××©×§×œ ×•×”××“×™× ×”"
    ]
  },
  {
    name: "××™×ª×™ (×˜×˜×¨×”)",
    aliases: ["××™×ª×™", "×˜×˜×¨×™×¡", "×˜×˜×¨×”"],
    user: "@loghop",
    left: false,
    traits: [
      "×¨×•×¡×™ ××ª×‘×•×œ×œ",
      "××•×”×‘ ×‘×•×œ×‘×•×œ×™×",
      "×’×¨ ×‘×—×™×¤×”",
      "××¢×“×™×£ ×¢×¨×‘×™×",
      "××‘×•×“ ×¢×¦×•×ª"
    ]
  },
  {
    name: "×™×•×’×™",
    aliases: ["×™×•×’×™"],
    user: "@drawacard",
    left: false,
    traits: [
      "×’×¨ ×‘××’×“×œ ×”×¢××§",
      "××›×•×¨ ×œ×”×™××•×¨×™×",
      "××›×•×¨ ×œ×–×•× ×•×ª",
      "×”×”×•×¨×™× ×©×œ×• ××—×™×",
      "××ª×‘×›×™×™×Ÿ ×‘×•×•×¨×–×•×Ÿ"
    ]
  },
  {
    name: "×¢××™ ×‘×•×§×• (××ª×”)",
    aliases: ["×¢××™", "×‘×•×§×•", "ami", "amiboko"],
    user: "@amiboko",
    left: false,
    traits: [
      "××ª×›× ×ª ×××©×“×•×“",
      "××›×•×¨ ×œ×§×•×“",
      "×’×•×œ×©",
      "××©×“×¨×’ ××ª ×©××¢×•×Ÿ ×‘××§×•× ×œ×¢×‘×•×“"
    ]
  },
  {
    name: "×¡×¤×™×Ÿ",
    aliases: ["×¡×¤×™×Ÿ", "×¢×•××¨×™", "×¦×¨×•×“"],
    phone: "+972526546332",
    user: null,
    left: false,
    traits: [
      "××™×© ×¦×‘×",
      "×§×•×œ ×”×›×™ ×¦×¨×•×“ ×‘×¢×•×œ×",
      "×¢×•×©×” ×¡×¤×™× ×™× ×œ×›×œ ××™ ×©××“×‘×¨ ××™×ª×•"
    ]
  }
];
function findMatchInText(text) {
  return PEOPLE.find(person =>
    person.aliases.some(alias => text.toLowerCase().includes(alias.toLowerCase()))
  );
}

async function generateRoastViaGPT(name, traits) {
  const prompt = `
××ª×” ×‘×•×˜ ×‘×©× ×©××¢×•×Ÿ. ×›×ª×•×‘ ×ª×’×•×‘×” ×¢×•×§×¦× ×™×ª, ××¦×—×™×§×”, ××§×•×¨×™×ª ×•×œ×¢×™×ª×™× ××¨×•×©×¢×ª ×›×œ×¤×™ ××“× ×‘×©× "${name}".
×”×××¤×™×™× ×™× ×©×œ×•: ${traits.join(", ")}.
××œ ×ª×©×ª××© ×‘×©× ×©×œ×š. ××œ ×ª×¦× ×–×¨. ×ª×Ÿ ××©×¤×˜ ×—×“ ×©×™×’×¨×•× ×œ×›×•×œ× ×œ×—×™×™×š ×•×œ${name} ×œ×—×©×•×‘ ×¤×¢××™×™×.
×”×ª×™×™×—×¡ ××œ×™×• ×‘×’×•×£ ×©×œ×™×©×™ ×‘×œ×‘×“.
×× ×™×© ×¢×œ ××” â€“ ×ª×©×ª××© ×‘×–×”. ×× ××™×Ÿ â€“ ×ª××¦×™× ×‘×œ×™ ×‘×•×©×”.
`;

  try {
    const response = await openai.chat.completions.create({
      model: "gpt-4o",
      messages: [{ role: "user", content: prompt }],
      temperature: 0.9,
      max_tokens: 60
    });

    return response.choices?.[0]?.message?.content?.trim() || "×”×•× ×œ× ×©×•×•×” ××¤×™×œ×• ×ª×’×•×‘×”.";
  } catch (err) {
    console.error("ğŸ”¥ ×©×’×™××” ×‘Ö¾GPT Roast:", err);
    return "×”×™×™×ª×™ ×™×•×¨×“ ×¢×œ×™×•, ××‘×œ ×’× GPT ×¡×™×¨×‘.";
  }
}

async function analyzeTextForRoast(text) {
  const match = findMatchInText(text);
  if (!match) return null;

  // ×× ×¢×–×‘ â€“ ×¨×•××¡×˜ ×—×•×¤×©×™
  if (match.left) {
    return await generateRoastViaGPT(match.name, match.traits);
  }

  // ×× ×™×© ×™×•×–×¨ â€” ×ª×’×•×‘×” ×¢× ×ª×™×•×’
  if (match.user) {
    return `ğŸ‘€ × ×¨××” ×©××ª×” ××“×‘×¨ ×¢×œ ${match.user}`;
  }

  // ×× ×™×© ×¨×§ ×˜×œ×¤×•×Ÿ â€” ×ª×’×•×‘×” ×›×œ×œ×™×ª
  return `ğŸ‘€ ××ª×” ××“×‘×¨ ×¢×œ ${match.name}, ××‘×œ ×”×•× ××¡×ª×ª×¨ ×××—×•×¨×™ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ.`;
}

module.exports = {
  analyzeTextForRoast
};
